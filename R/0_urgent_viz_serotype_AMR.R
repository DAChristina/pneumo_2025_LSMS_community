library(tidyverse)
source("global/fun.R")

# data viz just only for serotype & AMR ########################################
df_epi_gen_pneumo <- read.csv("inputs/genData_pneumo_with_epiData_with_final_pneumo_decision.csv") %>% 
  # dplyr::filter(workPoppunk_qc == "pass_qc") %>%
  dplyr::filter(workWGS_species_pw == "Streptococcus pneumoniae") %>% 
  dplyr::mutate(
    serotype_final_decision = case_when(
      serotype_final_decision == "mixed serotypes/serogroups" ~ "mixed serogroups",
      TRUE ~ serotype_final_decision
    ),
    serotype_final_decision = factor(serotype_final_decision,
                                     levels = c(
                                       # VT
                                       # "3", "6A/6B", "6A/6B/6C/6D", "serogroup 6",
                                       # "14", "17F", "18C/18B", "19A", "19F", "23F",
                                       "1", "3", "4", "5", "7F",
                                       "6A", "6B", "9V", "14", "18C",
                                       "19A", "19F", "23F",
                                       # NVT
                                       # "7C", "10A", "10B", "11A/11D", "13", "15A", "15B/15C",
                                       # "16F", "19B", "20", "23A", "23B", "24F/24B", "25F/25A/38",
                                       # "28F/28A", "31", "34", "35A/35C/42", "35B/35D", "35F",
                                       # "37", "39", "mixed serogroups",
                                       "serogroup 6", "6C", "7C",
                                       "10", "10A", "10B",
                                       "11A", "13", "15A", "15B", "15C", "16F",
                                       "17F", "18B", "19B", "20", "20B", "21",
                                       "23A", "23B", "23B1",
                                       "24B/C/F", "24F", "25B",
                                       "28A", "31", "33B", "33G",
                                       "34", "35A", "35B", "35C", "35F", "37",
                                       "37F", "38", "39",
                                       "nontypeable")),
    serotype_classification_PCV13_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                          levels = c("VT", "NVT", "nontypeable")),
    serotype_classification_PCV15_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                          levels = c("VT", "NVT", "nontypeable"))
  ) %>%
  glimpse()

table(df_epi_gen_pneumo$area)

# test classification df
test_classification <- df_epi_gen_pneumo %>% 
  dplyr::select(workWGS_serotype,
                serotype_final_decision,
                serotype_classification_PCV13_final_decision) %>% 
  # view() %>% 
  glimpse()


df_serotype_summary <- df_epi_gen_pneumo %>% 
  dplyr::count(serotype_final_decision) %>%
  dplyr::mutate(percentage = n / sum(n) * 100) %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>% 
      dplyr::select(serotype_final_decision,
                    serotype_classification_PCV13_final_decision)
    ,
    by = "serotype_final_decision"
  ) %>% 
  dplyr::distinct() %>% 
  # view() %>% 
  glimpse()

df_serotype_classification_summary <- df_epi_gen_pneumo %>% 
  dplyr::count(serotype_classification_PCV13_final_decision) %>%
  dplyr::mutate(percentage = n / sum(n) * 100) %>% 
  glimpse()

df_serotype_classification_perArea_summary <- df_epi_gen_pneumo %>% 
  dplyr::count(serotype_classification_PCV13_final_decision, area) %>%
  dplyr::mutate(percentage = n / sum(n) * 100) %>% 
  glimpse()

# compiled VT percentage per area
df_compiled_VT_percentage <- dplyr::left_join(
  df_epi_gen_pneumo %>% 
    dplyr::group_by(area, serotype_classification_PCV13_final_decision) %>% 
    dplyr::summarise(count_vacc = n(), .groups = "drop") %>% 
    dplyr::mutate(
      count_vacc = case_when(
        is.na(count_vacc) ~ 0,
        TRUE ~ count_vacc
      )
    )
  ,
  df_epi_gen_pneumo %>% 
    dplyr::group_by(area) %>% 
    dplyr::summarise(count_area = n(), .groups = "drop") %>% 
    dplyr::mutate(
      count_area = case_when(
        is.na(count_area) ~ 0,
        TRUE ~ count_area
      )
    )
  ,
  by = "area"
) %>% 
  dplyr::mutate(
    percent = round(count_vacc/count_area*100, 1),
    report_vaccination = paste0(count_vacc, " (", percent, "%)"),
    # vaccination_pcv13_dc_n_regroup = case_when(
    #   is.na(vaccination_pcv13_dc_n_regroup) ~ "0 not yet",
    #   T ~ vaccination_pcv13_dc_n_regroup
    # ),
    area = factor(area,
                  levels = c("lombok", "sumbawa", "manado", "sorong"))
  ) %>% 
  # view() %>% 
  glimpse()

png(file = "pictures/genData_serotypes_vaccineGroup.png",
    width = 23, height = 20, unit = "cm", res = 600)
ggplot(df_compiled_VT_percentage, aes(x = serotype_classification_PCV13_final_decision,
                                      y = percent,
                                      fill = area)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_text(aes(label = paste0(round(percent, 1), "%")),
            vjust = -0.5, size = 3,
            angle = 0,
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  # facet_grid(~ area,
  #            scales = "free_x",
  #            space = "free_x"
  # ) +
  scale_fill_manual(values = c(col_map)) +
  labs(x = "PCV13 Vaccine Group", y = "Percentage", 
       # title = "All Serotypes"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10),
        legend.position = c(0.02, 0.75),
        legend.direction = "vertical",
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = NA, color = NA),
        legend.title = element_blank(),
        legend.margin = margin(t = -50),
        legend.spacing.y = unit(-0.3, "cm")) # +
# facet_wrap(~ serotype_classification_PCV13_final_decision, nrow = 1, scales = "free_x")
dev.off()





ser1 <- ggplot(df_serotype_summary, aes(x = serotype_final_decision, y = percentage,
                                        fill = serotype_classification_PCV13_final_decision)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), vjust = -0.5, size = 3) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  labs(x = " ", y = "Percentage", 
       # title = "All Serotypes"
  ) +
  scale_fill_manual(values = c(col_map)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        legend.position = c(0.2, 0.75),
        legend.direction = "vertical",
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = NA, color = NA),
        legend.title = element_blank(),
        legend.margin = margin(t = -50),
        legend.spacing.y = unit(-0.3, "cm"))

# Compute percentage by area
df_serotype_area_summary <- df_epi_gen_pneumo %>% 
  dplyr::group_by(area, serotype_classification_PCV13_final_decision, serotype_final_decision) %>%
  dplyr::summarise(count = n(), .groups = "drop") %>%
  dplyr::mutate(percentage = count / sum(count) * 100,
                # slightly change classifications
                serotype_classification_PCV13_final_decision = case_when(
                  serotype_classification_PCV13_final_decision == "nontypeable" ~ " ",
                  TRUE ~ serotype_classification_PCV13_final_decision
                ),
                serotype_classification_PCV13_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                                      levels = c("VT", "NVT", " ")),
                area = factor(area,
                              levels = c("lombok", "sumbawa", "manado", "sorong"))
  )

ser2 <- ggplot(df_serotype_area_summary, aes(x = serotype_final_decision,
                                             y = percentage,
                                             fill = area)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  # geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5, size = 3) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  facet_grid(~ serotype_classification_PCV13_final_decision,
             scales = "free_x",
             space = "free_x"
  ) +
  scale_fill_manual(values = c(col_map)) +
  labs(x = "Category", y = "Percentage", 
       # title = "All Serotypes"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        legend.position = c(0.02, 0.75),
        legend.direction = "vertical",
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = NA, color = NA),
        legend.title = element_blank(),
        legend.margin = margin(t = -50),
        legend.spacing.y = unit(-0.3, "cm")) # +
# facet_wrap(~ serotype_classification_PCV13_final_decision, nrow = 1, scales = "free_x")

png(file = "pictures/genData_serotypes_classification_filterPneumo.png", width = 23, height = 25, unit = "cm", res = 600)
cowplot::plot_grid(ser1, ser2,
                   nrow = 2,
                   labels = c("A", "B"))
dev.off()

# AMR analyses & viz ###########################################################
# load df_epi_gen_pneumo first
# AMR and virulence factors use pass qc samples (n = 314)
df_epi_gen_pneumo <- read.csv("inputs/genData_pneumo_with_epiData_with_final_pneumo_decision.csv") %>% 
  # dplyr::filter(workPoppunk_qc == "pass_qc") %>%
  dplyr::filter(workWGS_species_pw == "Streptococcus pneumoniae") %>% 
  dplyr::mutate(
    serotype_final_decision = case_when(
      serotype_final_decision == "mixed serotypes/serogroups" ~ "mixed serogroups",
      TRUE ~ serotype_final_decision
    ),
    serotype_final_decision = factor(serotype_final_decision,
                                     levels = c(
                                       # VT
                                       # "3", "6A/6B", "6A/6B/6C/6D", "serogroup 6",
                                       # "14", "17F", "18C/18B", "19A", "19F", "23F",
                                       "1", "3", "4", "5", "7F",
                                       "6A", "6B", "9V", "14", "18C",
                                       "19A", "19F", "23F",
                                       # NVT
                                       # "7C", "10A", "10B", "11A/11D", "13", "15A", "15B/15C",
                                       # "16F", "19B", "20", "23A", "23B", "24F/24B", "25F/25A/38",
                                       # "28F/28A", "31", "34", "35A/35C/42", "35B/35D", "35F",
                                       # "37", "39", "mixed serogroups",
                                       "serogroup 6", "6C", "7C",
                                       "10", "10A", "10B",
                                       "11A", "13", "15A", "15B", "15C", "16F",
                                       "17F", "18B", "19B", "20", "20B", "21",
                                       "23A", "23B", "23B1",
                                       "24B/C/F", "24F", "25B",
                                       "28A", "31", "33B", "33G",
                                       "34", "35A", "35B", "35C", "35F", "37",
                                       "37F", "38", "39",
                                       "nontypeable")),
    serotype_classification_PCV13_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                          levels = c("VT", "NVT", "nontypeable")),
    serotype_classification_PCV15_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                          levels = c("VT", "NVT", "nontypeable"))
  ) %>%
  glimpse()

# cumulative AMR per-PCV13 vaccine type
amr_pcv13_long <- df_epi_gen_pneumo %>% 
  dplyr::select(serotype_classification_PCV13_final_decision,
                contains("workWGS_AMR_logic_class"),
                -workWGS_AMR_logic_class_counts
  ) %>% 
  tidyr::pivot_longer(
    cols = contains("workWGS_AMR_logic_class"),
    names_to = "class",
    values_to = "logic"
  ) %>% 
  dplyr::group_by(serotype_classification_PCV13_final_decision, class, logic) %>%
  dplyr::summarise(count = n(),
                   .groups = "drop") %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>% 
      dplyr::select(serotype_classification_PCV13_final_decision,
                    contains("workWGS_AMR_logic_class"),
                    -workWGS_AMR_logic_class_counts
      ) %>% 
      tidyr::pivot_longer(
        cols = contains("workWGS_AMR_logic_class"),
        names_to = "class",
        values_to = "logic"
      ) %>% 
      dplyr::group_by(serotype_classification_PCV13_final_decision, class) %>%
      dplyr::summarise(count_class = n(),
                       .groups = "drop")
    ,
    by = c("serotype_classification_PCV13_final_decision", "class")
  ) %>% 
  dplyr::mutate(
    percent = count/count_class*100
  ) %>% 
  dplyr::filter(
    logic == "TRUE"
  ) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(
    class = gsub("workWGS_AMR_logic_class_", "", class)
  ) %>% 
  # view() %>% 
  glimpse()

amr_grouped <- amr_pcv13_long %>% 
  # dplyr::filter(logic == "TRUE") %>% 
  dplyr::group_by(class, logic) %>% 
  dplyr::summarise(count = sum(count)) %>% 
  dplyr::ungroup() %>% 
  glimpse()

amr1 <- ggplot(amr_pcv13_long, aes(x = serotype_classification_PCV13_final_decision,
                                   y = percent,
                                   fill = class)) +
  # geom_line(size = 1.5) +
  geom_bar(stat = "identity", position = position_stack()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  # geom_text(aes(label = paste0(round(percentage, 2), "%")),
  #           position = position_dodge(width = 0.9),
  #           vjust = -0.3) +
  # scale_fill_manual(values = c(col_map)) +
  labs(x = " ", y = "Percentage", 
       # title = "All Serotypes"
  ) +
  theme_bw() +
  theme(legend.position = "none")
# theme(axis.text.x = element_text(angle = 0, hjust = 1, size = 10),
#       legend.position = "bottom", # c(0.02, 0.75),
#       legend.direction = "horizontal",
#       legend.justification = c("centre", "top"),
#       legend.background = element_rect(fill = NA, color = NA),
#       legend.title = element_blank(),
#       legend.margin = margin(t = -10),
#       legend.spacing.y = unit(-0.3, "cm"))


# cumulative AMR per-serotype
amr_ser_long <- df_epi_gen_pneumo %>% 
  dplyr::select(serotype_final_decision,
                contains("workWGS_AMR_logic_class"),
                -workWGS_AMR_logic_class_counts
  ) %>% 
  tidyr::pivot_longer(
    cols = contains("workWGS_AMR_logic_class"),
    names_to = "class",
    values_to = "logic"
  ) %>% 
  dplyr::group_by(serotype_final_decision, class, logic) %>%
  dplyr::summarise(count = n(),
                   .groups = "drop") %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>% 
      dplyr::select(serotype_final_decision,
                    contains("workWGS_AMR_logic_class"),
                    -workWGS_AMR_logic_class_counts
      ) %>% 
      tidyr::pivot_longer(
        cols = contains("workWGS_AMR_logic_class"),
        names_to = "class",
        values_to = "logic"
      ) %>% 
      dplyr::group_by(serotype_final_decision, class) %>%
      dplyr::summarise(count_class = n(),
                       .groups = "drop")
    ,
    by = c("serotype_final_decision", "class")
  ) %>% 
  dplyr::mutate(
    percent = count/count_class*100
  ) %>% 
  dplyr::filter(
    logic == "TRUE"
  ) %>% 
  # dplyr::group_by(serotype_final_decision, class) %>%
  # dplyr::summarise(percent = count/sum(count)*100) %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>% 
      dplyr::select(serotype_final_decision,
                    serotype_classification_PCV13_final_decision) %>% 
      dplyr::mutate(
        # slightly change classifications
        serotype_classification_PCV13_final_decision = case_when(
          serotype_classification_PCV13_final_decision == "nontypeable" ~ " ",
          TRUE ~ serotype_classification_PCV13_final_decision
        ),
        serotype_classification_PCV13_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                              levels = c("VT", "NVT", " "))
      )
    ,
    by = "serotype_final_decision"
    ,
    relationship = "many-to-many"
  ) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(
    class = gsub("workWGS_AMR_logic_class_", "", class)
  ) %>% 
  # view() %>% 
  glimpse()

amr2 <- ggplot(amr_ser_long, aes(x = serotype_final_decision,
                                 y = percent,
                                 fill = class)) +
  # geom_line(size = 1.5) +
  geom_bar(stat = "identity", position = position_stack()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  facet_grid(~ serotype_classification_PCV13_final_decision,
             scales = "free_x",
             space = "free_x"
  ) +
  # geom_text(aes(label = paste0(round(percentage, 2), "%")),
  #           position = position_dodge(width = 0.9),
  #           vjust = -0.3) +
  # scale_fill_manual(values = c(col_map)) +
  labs(x = " ", y = "Percentage", 
       # title = "All Serotypes"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        legend.position = "bottom", # c(0.02, 0.75),
        legend.direction = "horizontal",
        legend.justification = c("centre", "top"),
        legend.background = element_rect(fill = NA, color = NA),
        legend.title = element_blank(),
        legend.margin = margin(t = -25),
        legend.spacing.y = unit(-0.3, "cm"))


png(file = "pictures/genData_amr_filterPneumo.png", width = 23, height = 25, unit = "cm", res = 600)
cowplot::plot_grid(amr1, amr2,
                   nrow = 2,
                   labels = c("A", "B"))
dev.off()



# numeric AMR counts
df_amr_counts_summary <- df_epi_gen_pneumo %>% 
  dplyr::group_by(workWGS_AMR_logic_class_counts, serotype_final_decision) %>%
  dplyr::summarise(count = n()) %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>% 
      dplyr::group_by(serotype_final_decision) %>%
      dplyr::summarise(count_serotype = n())
    ,
    by = "serotype_final_decision"
  ) %>% 
  dplyr::mutate(
    percentage = ifelse(workWGS_AMR_logic_class_counts == "MDR",
                        count/count_serotype*100,
                        NA_real_),
    y_pos = count_serotype + 2
  ) %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>%
      dplyr::select(serotype_final_decision,
                    serotype_classification_PCV13_final_decision) %>%
      dplyr::mutate(
        # slightly change classifications
        serotype_classification_PCV13_final_decision = case_when(
          serotype_classification_PCV13_final_decision == "nontypeable" ~ " ",
          TRUE ~ serotype_classification_PCV13_final_decision
        ),
        serotype_classification_PCV13_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                              levels = c("VT", "NVT", " "))
      )
    ,
    by = "serotype_final_decision"
  ) %>%
  dplyr::mutate(
    workWGS_AMR_logic_class_counts = as.character(workWGS_AMR_logic_class_counts),
    workWGS_AMR_logic_class_counts = factor(workWGS_AMR_logic_class_counts,
                                            levels = c("7", "6", "5", "4", "3",
                                                       "2", "1", "0"))
  ) %>% 
  dplyr::distinct() %>% 
  # view() %>%
  glimpse()

# test plot
mdr1 <- ggplot(df_amr_counts_summary, aes(x = serotype_final_decision,
                                          y = count,
                                          fill = workWGS_AMR_logic_class_counts)) +
  # geom_line(size = 1.5) +
  geom_bar(stat = "identity", position = position_stack()) +
  # scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  facet_grid(~ serotype_classification_PCV13_final_decision,
             scales = "free_x",
             space = "free_x"
  ) +
  scale_fill_manual(values = c(col_map)) +
  labs(x = " ", y = "Count", 
       # title = "All Serotypes"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        legend.position = c(0.2, 0.75),
        legend.direction = "vertical",
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = NA, color = NA),
        legend.title = element_blank(),
        legend.margin = margin(t = -50),
        legend.spacing.y = unit(-0.3, "cm")) +
  guides(fill = guide_legend(ncol = 2))

df_amr_counts_classification_summary <- df_epi_gen_pneumo %>% 
  dplyr::count(workWGS_AMR_logic_class_counts) %>%
  dplyr::mutate(percentage = n / sum(n) * 100) %>% 
  glimpse()

df_amr_counts_classification_perArea_summary <- df_epi_gen_pneumo %>% 
  dplyr::count(workWGS_AMR_logic_class_counts, area) %>%
  dplyr::mutate(percentage = n / sum(n) * 100) %>% 
  glimpse()



# MDR flag
df_amr_mdr_summary <- df_epi_gen_pneumo %>% 
  dplyr::group_by(workWGS_AMR_MDR_flag, serotype_final_decision) %>%
  dplyr::summarise(count = n()) %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>% 
      dplyr::group_by(serotype_final_decision) %>%
      dplyr::summarise(count_serotype = n())
    ,
    by = "serotype_final_decision"
  ) %>% 
  dplyr::mutate(
    percentage = ifelse(workWGS_AMR_MDR_flag == "MDR",
                        count/count_serotype*100,
                        NA_real_),
    y_pos = count_serotype + 3
  ) %>% 
  dplyr::left_join(
    df_epi_gen_pneumo %>%
      dplyr::select(serotype_final_decision,
                    serotype_classification_PCV13_final_decision) %>%
      dplyr::mutate(
        # slightly change classifications
        serotype_classification_PCV13_final_decision = case_when(
          serotype_classification_PCV13_final_decision == "nontypeable" ~ " ",
          TRUE ~ serotype_classification_PCV13_final_decision
        ),
        serotype_classification_PCV13_final_decision = factor(serotype_classification_PCV13_final_decision,
                                                              levels = c("VT", "NVT", " "))
      )
    ,
    by = "serotype_final_decision"
  ) %>%
  dplyr::distinct() %>% 
  # view() %>%
  glimpse()

# test plot
mdr2 <- ggplot(df_amr_mdr_summary, aes(x = serotype_final_decision,
                                       y = count,
                                       fill = workWGS_AMR_MDR_flag)) +
  # geom_line(size = 1.5) +
  geom_bar(stat = "identity", position = position_stack()) +
  # scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  facet_grid(~ serotype_classification_PCV13_final_decision,
             scales = "free_x",
             space = "free_x"
  ) +
  geom_text(aes(x = serotype_final_decision,
                y = y_pos,
                label = ifelse(is.na(percentage),
                               NA,
                               paste0(round(percentage, 1), "%"))),
            # position = position_stack(vjust = 1.3),
            angle = 90,
            check_overlap = TRUE
  ) +
  scale_fill_manual(values = c(col_map)) +
  labs(x = " ", y = "Count", 
       # title = "All Serotypes"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        legend.position = c(0.02, 0.75),
        legend.direction = "vertical",
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = NA, color = NA),
        legend.title = element_blank(),
        legend.margin = margin(t = -50),
        legend.spacing.y = unit(-0.3, "cm"))

png(file = "pictures/genData_mdr_filterPneumo.png", width = 23, height = 25, unit = "cm", res = 600)
cowplot::plot_grid(mdr1, mdr2,
                   nrow = 2,
                   labels = c("A", "B"))
dev.off()
